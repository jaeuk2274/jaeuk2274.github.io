---
title: "스프링 데이터 JPA-20.EntityGraph, Projection"
date: 2020-01-10
categories: 
- Back-end
tags:
- Spring 
- Spring Data
- JPA
comments : true
---

## 스프링 데이터 JPA: EntityGraph
-쿼리 메소드 마다 연관 관계의 Fetch 모드를 설정 할 수 있습니다.

@NamedEntityGraph
- @Entity에서 재사용할 여러 엔티티 그룹을 정의할 때 사용.

@EntityGraph
- @NamedEntityGraph에 정의되어 있는 엔티티 그룹을 사용 함.
- 그래프 타입 설정 가능
  - (기본값) FETCH: 설정한 엔티티 애트리뷰트는 EAGER 패치 나머지는 LAZY 패치.
  - LOAD: 설정한 엔티티 애트리뷰트는 EAGER 패치 나머지는 기본 패치 전략 따름.



@ManyToOne(fetch = FetchType.LAZY)
라면 코멘트만 가져온다.

예제코드
1.
~~~java
// 연관관계만 정의
@NamedEntityGraph(name="Comment.post", attributeNodes = @NamedAttributeNode("post"))
@Entity @Getter @Setter
public class Comment {
~~~

~~~java
public interface CommentRepository extends JpaRepository<Comment, Long> {

    @EntityGraph(value = "Comment.post")
    Optional<Comment> getById(Long id);
~~~

2. 엔티티에 선언한 @NamedEntityGraph를 메소드에 정의
~~~java
public interface CommentRepository extends JpaRepository<Comment, Long> {

    @EntityGraph(attributePaths = "post")
    Optional<Comment> getById(Long id);
~~~

둘 다 동일.     
조인해서 post도 가져온다.


## 스프링 데이터 JPA: Projection
엔티티의 일부 데이터만 가져오기.

인터페이스 기반 프로젝션
- Nested 프로젝션 가능.
- Closed 프로젝션
  - 쿼리를 최적화 할 수 있다. 가져오려는 애트리뷰트가 뭔지 알고 있으니까.
  - Java 8의 디폴트 메소드를 사용해서 연산을 할 수 있다.
- Open 프로젝션
  - @Value(SpEL)을 사용해서 연산을 할 수 있다. 스프링 빈의 메소드도 호출 가능.
  - 쿼리 최적화를 할 수 없다. SpEL을 엔티티 대상으로 사용하기 때문에.

클래스 기반 프로젝션
- DTO
- 롬복 @Value로 코드 줄일 수 있음

다이나믹 프로젝션
- 프로젝션 용 메소드 하나만 정의하고 실제 프로젝션 타입은 타입 인자로 전달하기.

~~~java
<T> List<T> findByPost_Id(Long id, Class<T> type);
~~~
